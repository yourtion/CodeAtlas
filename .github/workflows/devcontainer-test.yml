name: DevContainer Test

on:
  push:
    branches: [main, develop]
    paths:
      - '.devcontainer/**'
      - 'scripts/seed_data.sql'
      - 'scripts/init_devcontainer.sh'
      - 'scripts/test_devcontainer.sh'
  pull_request:
    branches: [main, develop]
    paths:
      - '.devcontainer/**'
      - 'scripts/seed_data.sql'
      - 'scripts/init_devcontainer.sh'
      - 'scripts/test_devcontainer.sh'
  workflow_dispatch:

jobs:
  test-devcontainer:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build devcontainer
        run: |
          docker-compose -f .devcontainer/docker-compose.yml build

      - name: Start devcontainer services
        run: |
          docker-compose -f .devcontainer/docker-compose.yml up -d
          
      - name: Wait for database
        run: |
          timeout 60 bash -c 'until docker-compose -f .devcontainer/docker-compose.yml exec -T db pg_isready -U codeatlas -d codeatlas; do sleep 2; done'

      - name: Check database schema
        run: |
          docker-compose -f .devcontainer/docker-compose.yml exec -T db psql -U codeatlas -d codeatlas -c "\dt"

      - name: Verify seed data
        run: |
          REPO_COUNT=$(docker-compose -f .devcontainer/docker-compose.yml exec -T db psql -U codeatlas -d codeatlas -t -c "SELECT COUNT(*) FROM repositories;" | xargs)
          echo "Repository count: $REPO_COUNT"
          if [ "$REPO_COUNT" -lt 1 ]; then
            echo "Error: No repositories found in database"
            exit 1
          fi

      - name: Test Go build
        run: |
          docker-compose -f .devcontainer/docker-compose.yml exec -T dev make build

      - name: Run tests with enhanced output
        run: |
          docker-compose -f .devcontainer/docker-compose.yml exec -T dev make test-ci
      
      - name: Extract test results
        if: always()
        run: |
          # Copy test report from container
          docker cp $(docker-compose -f .devcontainer/docker-compose.yml ps -q dev):/workspace/test_report_*.json . 2>/dev/null || true
          
          # Display summary if report exists
          if ls test_report_*.json 1> /dev/null 2>&1; then
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            REPORT=$(ls -t test_report_*.json | head -1)
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat "$REPORT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-test-report
          path: test_report_*.json
          if-no-files-found: ignore
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f .devcontainer/docker-compose.yml down -v
